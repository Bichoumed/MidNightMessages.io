<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Midnight Reasons â€¢ ğŸ’Œ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800;1000&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<meta name="color-scheme" content="light dark" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%92%8C%3C/text%3E%3C/svg%3E">
<style>
:root{
  --bg1:#0b0b22; --bg2:#1a1030; --ink:#f5f6ff; --muted:#cdd0f2; --line:#2c2c52;
  --card:#0f1030cc; --blur:14px; --pink:#ff7ecf; --blue:#7aa2ff; --gold:#f6d365; --rose:#ff5e8e; --vio:#a78bfa;
  --accent-grad: conic-gradient(from 120deg, var(--pink), var(--blue), var(--gold));
}
@media (prefers-color-scheme: light){
  :root{ --bg1:#fff7fb; --bg2:#f4f8ff; --ink:#1a1b2e; --muted:#5c6080; --line:#e6e6f7; --card:#ffffffcc; }
}
*{box-sizing:border-box}
html,body{height:100%;}
body{margin:0; color:var(--ink); font-family:'Cairo',system-ui,Segoe UI,Roboto,Arial; background:
            radial-gradient(1200px 800px at 15% 10%, rgba(255,126,207,.18), transparent 60%),
            radial-gradient(1200px 800px at 85% 90%, rgba(122,162,255,.18), transparent 60%),
            linear-gradient(160deg, var(--bg1), var(--bg2));
  overflow-x:hidden; position:relative;
}
/* Ù†Ø¬ÙˆÙ… Ø®ÙÙŠÙØ© */
#stars{position:fixed; inset:0; pointer-events:none; opacity:.6}
/* Ø­Ø¨ÙŠØ¨Ø§Øª */
#grain{position:fixed; inset:0; pointer-events:none; mix-blend-mode:soft-light; opacity:.14; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.6"/></svg>');}

.container{width:min(1150px,92vw); margin: clamp(18px, 4vw, 46px) auto;}
.header{display:flex; align-items:center; justify-content:space-between; gap:16px;}
.brand{display:flex; align-items:center; gap:14px;}
.logo{width:56px; height:56px; border-radius:16px; display:grid; place-items:center; font-size:26px; 
  background: var(--accent-grad); box-shadow:0 10px 30px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.08) inset;}
.brand h1{font-family:'Playfair Display',serif; font-weight:700; letter-spacing:.4px; font-size:clamp(24px,3.2vw,36px); margin:0;}
.tagline{margin:.15rem 0 0; color:var(--muted); font-weight:600}
.actions{display:flex; gap:10px;}
.btn{border:1px solid rgba(255,255,255,.15); background:linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.04)); color:var(--ink); padding:10px 16px; border-radius:999px; font-weight:800; cursor:pointer; backdrop-filter: blur(8px); box-shadow:0 10px 30px rgba(0,0,0,.15);} .btn:hover{transform: translateY(-1px);} .btn:active{transform:translateY(0)}
.primary{border-color:transparent; background:linear-gradient(90deg, var(--pink), var(--blue)); color:white}

.hero{margin:26px 0 16px; display:grid; grid-template-columns: 1.05fr .95fr; gap:22px;}
@media (max-width: 980px){ .hero{grid-template-columns: 1fr;}}
.card{position:relative; isolation:isolate; border-radius:26px; background:var(--card); border:1px solid rgba(255,255,255,.18); backdrop-filter: blur(var(--blur)); box-shadow: 0 22px 60px rgba(0,0,0,.28), 0 0 0 1px rgba(255,255,255,.08) inset; overflow:hidden;}
.card .glow{position:absolute; inset:-2px; background: radial-gradient(420px 160px at var(--mx,80%) var(--my,30%), rgba(138,92,246,.3), transparent 60%); filter: blur(22px); z-index:-1;}

/* Today + TIMER */
.note{padding:28px; display:grid; grid-template-columns: 1.2fr .8fr; gap:22px; min-height:300px; align-items:center}
@media (max-width: 760px){ .note{grid-template-columns:1fr;}}
.titleBig{font-family:'Playfair Display',serif; font-size:clamp(22px,3.2vw,34px); line-height:1.6; margin:6px 0 0;}
.kicker{display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:700}
.kicker .chip{font-variant-numeric:tabular-nums; border:1px solid var(--line); padding:5px 12px; border-radius:999px; background:linear-gradient(0deg, rgba(255,255,255,.08), rgba(255,255,255,.02));}
.meta{display:flex; gap:8px; align-items:center; color:var(--muted); font-weight:700}

.timer{--size: 230px; position:relative; width:var(--size); height:var(--size); place-self:center; display:grid; place-items:center}
.ring{position:absolute; inset:0; border-radius:50%;}
.ring::after{content:""; position:absolute; inset:0; border-radius:50%; box-shadow:inset 0 0 0 1px rgba(255,255,255,.12), inset 0 10px 25px rgba(0,0,0,.2)}
.ring.h{--p: var(--p-hour, 0); padding:8px; background: conic-gradient(var(--rose) calc(var(--p)*1%), transparent 0); mask: radial-gradient(circle at center, transparent 60%, #000 61%);}
.ring.m{--p: var(--p-min, 0); inset:14px; padding:8px; background: conic-gradient(var(--blue) calc(var(--p)*1%), transparent 0); mask: radial-gradient(circle at center, transparent 60%, #000 62%);}
.ring.s{--p: var(--p-sec, 0); inset:28px; padding:8px; background: conic-gradient(var(--gold) calc(var(--p)*1%), transparent 0); mask: radial-gradient(circle at center, transparent 60%, #000 63%);}
.core{position:absolute; inset:52px; border-radius:50%; display:grid; place-items:center; background:radial-gradient(120px 80px at 60% 30%, rgba(255,255,255,.16), rgba(255,255,255,.03)); box-shadow:inset 0 0 0 1px rgba(255,255,255,.14)}
.core .num{font-size:34px; font-weight:1000; letter-spacing:.5px; font-variant-numeric:tabular-nums}
.core small{color:var(--muted); font-weight:700}
.core .heart{position:absolute; bottom:-6px; font-size:18px; animation: pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)} 50%{transform:scale(1.15)}}

/* Timeline */
.timeline{padding:24px;}
.timeline h3{margin:0 0 10px; font-size:18px; color:var(--muted); font-weight:900}
.items{display:grid; grid-template-columns: repeat(2, 1fr); gap:14px;}
@media (max-width: 980px){ .items{grid-template-columns:1fr;}}
.item{position:relative; border-radius:18px; border:1px dashed var(--line); padding:14px 16px 14px 54px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));}
.item::before{content:""; position:absolute; right:auto; left:18px; top:18px; width:22px; height:22px; border-radius:8px; background: var(--accent-grad); box-shadow:0 0 0 6px rgba(124,58,237,.15)}
.item h4{margin:0 0 6px; font-weight:900}
.item p{margin:0; color:var(--muted)}
.locked{filter:saturate(.6) contrast(.9); opacity:.65; position:relative}
.locked .veil{position:absolute; inset:0; backdrop-filter: blur(2px); display:grid; place-items:center; font-weight:900; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.4)}

/* ÙÙˆØ§ØµÙ„ Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ© */
.sep{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); margin:8px 0}
.quote{color:var(--muted); font-weight:800; letter-spacing:.2px}

/* Dialog */
.dialog{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(5,6,20,.45); z-index:1000;}
.dialog[open]{display:flex}
.modal{width:min(860px,92vw); background:var(--card); border:1px solid rgba(255,255,255,.2); border-radius:22px; box-shadow:0 30px 80px rgba(0,0,0,.45); overflow:hidden}
.modal .hd{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--line)}
.modal .bd{padding:18px}
input, textarea{width:100%; border-radius:12px; border:1px solid var(--line); padding:10px 12px; background:rgba(255,255,255,.06); color:inherit; font-family:inherit}
label{font-size:13px; color:var(--muted)}
textarea{min-height:220px; resize:vertical}

.tip{position:relative}
.tip:hover::after{content:attr(data-tip); position:absolute; bottom:120%; right:50%; transform:translateX(50%); background:#000c; color:#fff; padding:6px 8px; border-radius:8px; font-size:12px; white-space:nowrap}
.fla{position:fixed; inset:0; pointer-events:none}
.spark{position:absolute; font-size:14px; animation: drift 4s ease-in forwards; opacity:.95}
@keyframes drift{from{transform:translateY(0) scale(1)} to{transform:translateY(-120vh) scale(1.25); opacity:0}}
.small{font-size:12px; color:var(--muted)}
.toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

/* Parallax tilt */
#todayCard{transition: transform .18s ease}
</style>
</head>
<body>
<canvas id="stars"></canvas>
<div id="grain"></div>
<div class="container">
  <header class="header">
    <div class="brand tip" id="brandHold" data-tip="Ø¥Ø¨Ù‚Ù Ø¥ØµØ¨Ø¹Ùƒ Ù¡.Ù¥ Ø«Ø§Ù†ÙŠØ© Ù„ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
      <div class="logo">ğŸ’Œ</div>
      <div>
        <h1>Midnight Reasons</h1>
        <p class="tagline">Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ ØªÙÙØªØ­ ÙƒÙ„ Ù…Ù†ØªØµÙ Ù„ÙŠÙ„ â€¢ Africa/Nouakchott</p>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="copyBtn">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
      <button class="btn primary" id="shareBtn">Ù…Ø´Ø§Ø±ÙƒØ©</button>
    </div>
  </header>

  <section class="hero" id="tilt">
    <div class="card" id="todayCard">
      <div class="glow"></div>
      <div class="note">
        <div>
          <div class="kicker">
            <span class="chip" id="chipNum">Ø§Ù„ÙŠÙˆÙ… â€”</span>
            <span>Ø§Ù„ÙŠÙˆÙ… â€¢ <span id="dateNow">â€”</span></span>
          </div>
          <h2 class="titleBig" id="today">ØªØµÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ù„Ø¨ Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ âœ¨</h2>
          <div class="sep"></div>
     <div class="quote"> Ù…Ù† Ø¨ÙØ´Ø±Ù‰ Ø¥Ù„Ù‰ Ù…Ø­Ù…Ø¯ Ù…Ø§ Ø¨ÙŠÙ†ÙŠ ÙˆØ¨ÙŠÙ†Ùƒ ÙˆØ¹Ø¯Ù Ù„ÙŠÙ„Ù Ù„Ø·ÙŠÙâ€¦ ÙŠÙƒØªÙ…Ù„ Ø¨Ø±Ø³Ø§Ù„Ø© Ø­Ø¨.</div>
        </div>
        <div class="timer" aria-label="Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„">
          <div class="ring h"></div>
          <div class="ring m"></div>
          <div class="ring s"></div>
          <div class="core">
            <div class="num" id="count">00:00:00</div>
            <small id="nextExact">â€”</small>
            <div class="heart">ğŸ’–</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="glow"></div>
      <div class="timeline">
        <h3>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
        <div class="items" id="archive"></div>
        <p class="small">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© ØªØ¨Ù‚Ù‰ Ù…ØºÙ„Ù‚Ø© Ù„ØªØ¨Ù‚Ù‰ Ø§Ù„Ù…ÙØ§Ø¬Ø£Ø© Ø£Ø¬Ù…Ù„ ğŸ’«</p>
      </div>
    </div>
  </section>
</div>
<div class="fla" id="fla"></div>

<!-- Admin Modal -->
<div class="dialog" id="admin">
  <div class="modal">
    <div class="hd"><strong>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</strong> <button class="btn" id="closeAdmin">Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div class="bd">
      <div style="display:grid; gap:12px; grid-template-columns: 1fr 1fr;">
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (YYYY-MM-DD)</label>
          <input id="startInput" placeholder="2025-09-21" />
        </div>
        <div>
          <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
          <input id="tzInput" placeholder="Africa/Nouakchott" />
        </div>
      </div>

      <div class="toolbar">
        <input type="file" id="fileInput" accept=".json,.txt" style="display:none"/>
        <button class="btn" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù</button>
        <button class="btn" id="exportBtn">ØªØµØ¯ÙŠØ± JSON</button>
        <button class="btn" id="reloadRemote">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø±Ø§Ø¨Ø·</button>
        <span class="small">ÙŠÙ…ÙƒÙ†ÙƒÙ Ø£ÙŠØ¶Ù‹Ø§ Ø±ÙØ¹ <code>messages.json</code> Ø¨Ø¬Ø§Ù†Ø¨ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØªÙ…Ø±ÙŠØ± <code>?src=</code> ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.</span>
      </div>

      <div style="height:8px"></div>
      <label>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ÙƒÙ„ Ø³Ø·Ø± Ø±Ø³Ø§Ù„Ø©)</label>
      <textarea id="msgInput" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ù‡Ù†Ø§â€¦"></textarea>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px">
        <button class="btn" id="resetBtn">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
        <button class="btn primary" id="saveBtn">Ø­ÙØ¸</button>
      </div>
      <p class="small">Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø§Ù„Ù…ØªØµÙØ­). Ù„Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªØ¨Ø¯Ù„ÙŠ Ù…Ù„Ù <code>messages.json</code>.</p>
    </div>
  </div>
</div>

<script>
/* ========= External source support =========
1) Place a file named messages.json next to index.html (same origin) with:
{
  "start_date": "2025-09-25",
  "timezone": "Africa/Nouakchott",
  "messages": ["note 1", "note 2", "..."]
}
2) Or pass a remote URL via query param: ?src=https://gist.githubusercontent.com/.../raw/messages.json
(Ensure the URL allows CORS â€” GitHub raw and Gist raw do.)
*/

/* =================== CONFIG =================== */
const DEFAULT_TZ = 'Africa/Nouakchott';
const DEFAULT_MESSAGES = [
  "Ø£Ø­Ø¨ Ø¶Ø­ÙƒØªÙƒ Ø§Ù„ØªÙŠ ØªØ²ÙŠÙ„ Ø¹Ù†ÙŠ ÙƒÙ„ Ù‡Ù…. ÙƒÙ„Ù…Ø§ Ø³Ù…Ø¹Øª ØµÙˆØªÙƒ ÙˆØ£Ù†Øª ØªØ¶Ø­ÙƒØŒ Ø£Ø´Ø¹Ø± Ø£Ù† Ø§Ù„Ø¹Ø§Ù„Ù… Ø£Ø®ÙÙ‘ ÙˆØ£Ù† Ø­Ø²Ù†ÙŠ ÙŠØ°ÙˆØ¨ ÙÙŠ Ù„Ø­Ø¸Ø© ÙˆØ§Ø­Ø¯Ø©.",
  "Ø£Ù†Øª ØªÙ„Ø§Ø­Ø¸ Ø£ØµØºØ± Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙŠ ØªÙ‡Ù…Ù†ÙŠâ€¦ Ù‡Ø°Ø§ Ù…Ø§ ÙŠØ¬Ø¹Ù„Ù†ÙŠ Ø£Ø´Ø¹Ø± Ø£Ù†Ùƒ ØªØ¹Ø±ÙÙ†ÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ù†ÙØ³ÙŠØŒ ÙˆØ£Ù†Ùƒ ØªØ±Ù‰ Ù…Ø§ Ù„Ø§ ÙŠØ±Ø§Ù‡ Ø£Ø­Ø¯.",
  "Ø£Ø´Ø¹Ø± Ø¨Ø§Ù„Ø£Ù…Ø§Ù† Ø¹Ù†Ø¯Ù…Ø§ Ø£ØªÙƒÙ„Ù… Ù…Ø¹ÙƒØŒ ÙƒØ£Ù† ØµÙˆØªÙƒ Ø¬Ø¯Ø§Ø± ÙŠØ­Ù…ÙŠ Ù‚Ù„Ø¨ÙŠ Ù…Ù† ÙƒÙ„ Ø®ÙˆÙ. Ø£Ø³ØªØ·ÙŠØ¹ Ø£Ù† Ø£Ø¨ÙˆØ­ Ù„Ùƒ Ø¨ÙƒÙ„ Ù…Ø§ ÙÙŠ Ø¯Ø§Ø®Ù„ÙŠ Ø¨Ù„Ø§ ØªØ±Ø¯Ø¯.",
  "Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ø£Ø¬Ù…Ù„ Ù…Ù† Ø£ÙŠ Ø±Ø­Ù„Ø© ÙƒØ¨ÙŠØ±Ø©Ø› Ù„Ø£Ù† ÙˆØ¬ÙˆØ¯Ùƒ ÙÙŠÙ‡Ø§ ÙŠØ¬Ø¹Ù„Ù‡Ø§ Ø°Ù‡Ø¨ÙŠØ©ØŒ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ø¬Ø±Ø¯ Ù„Ø­Ø¸Ø§Øª Ø¹Ø§Ø¨Ø±Ø© ÙÙŠ Ø§Ù„Ø´Ø§Ø±Ø¹ Ø£Ùˆ Ø§Ù„Ù…Ù‚Ù‡Ù‰.",
  "Ø§Ø¨ØªØ³Ø§Ù…ØªÙƒ Ù‡ÙŠ Ø¥Ø´Ø¹Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¶Ù„ ÙƒÙ„ ÙŠÙˆÙ…. Ù„Ø§ Ø£Ø­ØªØ§Ø¬ Ù‡Ø§ØªÙÙŠ Ù„Ø£ÙØ±Ø­ØŒ ÙŠÙƒÙÙŠÙ†ÙŠ Ø£Ù† Ø£Ø±Ø§Ùƒ ØªØ¨ØªØ³Ù… Ù„ØªØ¶ÙŠØ¡ Ø§Ù„Ø¯Ù†ÙŠØ§ Ù…Ù† Ø­ÙˆÙ„ÙŠ.",
  "ØµØ¨Ø±Ùƒ Ø¹Ù„ÙŠÙ‘ ÙŠØ¬Ø¹Ù„Ù†ÙŠ Ø£Ø­Ø¨Ùƒ Ø£ÙƒØ«Ø±. ÙØ£Ù†Øª ØªØªØ­Ù…Ù„ ØªÙ‚Ù„Ø¨Ø§ØªÙŠØŒ ÙˆØªØ­ØªÙˆÙŠÙ†ÙŠ Ø¨Ø­Ù†Ø§Ù†ÙƒØŒ ÙˆÙƒØ£Ù†Ùƒ ØªÙ‚ÙˆÙ„ Ù„ÙŠ: Ù…Ù‡Ù…Ø§ ÙƒÙ†ØªÙØŒ Ø£Ù†Ø§ Ù…Ø¹Ùƒ.",
  "ØªØ­ÙˆÙ‘Ù„ Ù„Ø­Ø¸Ø§ØªÙ†Ø§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¥Ù„Ù‰ ÙÙŠÙ„Ù… Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ› ÙÙŠ Ø¹ÙŠÙ†ÙŠÙƒ ÙƒÙ„ Ù…Ø´Ù‡Ø¯ Ù„Ù‡ Ù…Ø¹Ù†Ù‰ØŒ ÙˆÙÙŠ Ù‚Ø±Ø¨Ùƒ ÙƒÙ„ Ù„Ù‚Ø·Ø© ØªØµØ¨Ø­ Ø£Ø¬Ù…Ù„ Ù…Ù† Ø£Ù„Ù Ø±ÙˆØ§ÙŠØ©.",
  "Ø·ÙŠØ¨ØªÙƒ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† ØªØ¬Ø¹Ù„Ù†ÙŠ ÙØ®ÙˆØ±Ø© Ø¨ÙƒØŒ Ø£Ø´Ø¹Ø± Ø£Ù†Ù†ÙŠ Ø§Ø®ØªØ±Øª Ø¥Ù†Ø³Ø§Ù†Ù‹Ø§ ÙŠØ­Ù…Ù„ Ù‚Ù„Ø¨Ù‹Ø§ Ù†Ø§Ø¯Ø±Ù‹Ø§ØŒ Ù‚Ù„Ø¨Ù‹Ø§ Ø±Ø­ÙŠÙ…Ù‹Ø§ ÙŠÙˆØ²Ø¹ Ø§Ù„Ø®ÙŠØ± Ø­ÙŠØ«Ù…Ø§ Ø°Ù‡Ø¨.",
  "Ù…Ø²Ø§Ø­Ù†Ø§ Ø§Ù„Ø®Ø§Øµ Ù‡Ùˆ Ù„ØºØªÙ†Ø§ Ø§Ù„Ø³Ø±ÙŠØ©Ø› Ù†Ø¶Ø­Ùƒ Ø¹Ù„Ù‰ Ø£Ø´ÙŠØ§Ø¡ Ù„Ø§ ÙŠÙÙ‡Ù…Ù‡Ø§ Ø³ÙˆØ§Ù†Ø§ØŒ ÙˆÙƒØ£Ù†Ù†Ø§ Ø®Ù„Ù‚Ù†Ø§ Ø¹Ø§Ù„Ù…Ù‹Ø§ ØµØºÙŠØ±Ù‹Ø§ Ù„Ù†Ø§ ÙˆØ­Ø¯Ù†Ø§.",
  "Ø£Ø­Ø¨Ù†Ø§â€¦ Ø§Ù„ÙŠÙˆÙ… ÙˆØºØ¯Ù‹Ø§ ÙˆØ¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¯. ÙØ£Ù†Ø§ Ø£Ø¤Ù…Ù† Ø£Ù† Ù‚ØµØªÙ†Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¸Ø±ÙˆÙØŒ ÙˆØ£Ù† Ø­Ø¨Ù†Ø§ Ø³ÙŠØ¨Ù‚Ù‰ Ø­ÙŠÙ‹Ø§ Ù…Ù‡Ù…Ø§ Ù…Ø±Ù‘ Ø§Ù„Ø²Ù…Ø§Ù†."
];

const DEFAULT_START = (()=>{ const d=new Date(); d.setHours(0,0,0,0); return d; })();

const KEY_MSGS = 'mr.v3.msgs';
const KEY_START = 'mr.v3.start';
const KEY_TZ = 'mr.v3.tz';
const KEY_SRC = 'mr.v3.src';

/* =================== UTIL =================== */
function zonedNow(tz){
  const f = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const p = Object.fromEntries(f.formatToParts(new Date()).map(x=>[x.type,x.value]));
  return new Date(`${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}:${p.second}`);
}
function fmtFull(d, tz){ return new Intl.DateTimeFormat('ar-EG',{dateStyle:'full', timeStyle:'short', timeZone:tz}).format(d) }
function dayIndex(now, start){ return Math.max(0, Math.floor((now - start)/86400000)); }
function nextMidnight(now){ const n=new Date(now); n.setHours(24,0,0,0); return n }
function $(id){ return document.getElementById(id) }
function save(k,v){ localStorage.setItem(k, typeof v==='string'? v : JSON.stringify(v)) }
function load(k,fallback){ try{ const v=localStorage.getItem(k); if(!v) return fallback; return JSON.parse(v) }catch{ return localStorage.getItem(k)||fallback }
}
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=filename; a.click(); URL.revokeObjectURL(a.href) }

/* =================== REMOTE LOADING =================== */
async function fetchMessagesFrom(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const data = await res.json();
  if(!Array.isArray(data.messages)) throw new Error('Invalid schema: missing messages[]');
  return {
    messages: data.messages.map(String),
    start: data.start_date ? new Date(data.start_date+'T00:00:00') : DEFAULT_START,
    tz: data.timezone || DEFAULT_TZ
  };
}

async function tryLoadExternal(){
  const qs = new URLSearchParams(location.search);
  const explicit = qs.get('src');
  const stored = load(KEY_SRC, null);
  const candidates = [explicit, stored, 'messages.json'].filter(Boolean);
  for(const url of candidates){
    try{
      const {messages,start,tz} = await fetchMessagesFrom(url);
      save(KEY_MSGS, messages); save(KEY_START, start.toISOString()); save(KEY_TZ, tz); save(KEY_SRC, url);
      return {messages,start,tz, src:url};
    }catch(e){ /* continue trying */ }
  }
  return null; // fall back to local/defaults
}

/* =================== STATE =================== */
let TZ = load(KEY_TZ, DEFAULT_TZ);
let MESSAGES = load(KEY_MSGS, DEFAULT_MESSAGES);
let START = (()=>{ const raw = load(KEY_START, DEFAULT_START.toISOString()); const d=new Date(raw); return isNaN(+d)? DEFAULT_START : d; })();
let SRC = load(KEY_SRC, null);

/* =================== RENDER =================== */
const $today=$('today'), $chipNum=$('chipNum'), $dateNow=$('dateNow'), $count=$('count'), $archive=$('archive'), $nextExact=$('nextExact');
const timerEl = document.querySelector('.timer');
let lastDay=-1;

function setTimerProgress(msUntil){
  const total = 24*3600*1000;
  const now = total - msUntil; // elapsed today
  // remaining time -> ring fill (reverse feels nicer)
  const sec = Math.floor(msUntil/1000)%60;
  const min = Math.floor(msUntil/60000)%60;
  const hrs = Math.floor(msUntil/3600000);
  const pHour = (hrs/24)*100;
  const pMin  = (min/60)*100;
  const pSec  = (sec/60)*100;
  timerEl.style.setProperty('--p-hour', 100 - pHour);
  timerEl.style.setProperty('--p-min',  100 - pMin);
  timerEl.style.setProperty('--p-sec',  100 - pSec);
}

function renderAll(){
  const now = zonedNow(TZ);
  const idx = Math.min(dayIndex(now, START), MESSAGES.length-1);
  const unlocked = Math.max(0, Math.min(idx, MESSAGES.length-1));
  $today.textContent = MESSAGES[unlocked] || 'â€”';
  $chipNum.textContent = `Ø§Ù„ÙŠÙˆÙ… ${unlocked+1}`;
  $dateNow.textContent = fmtFull(now, TZ);
  buildArchive(unlocked);
  updateCount(now);
}
function buildArchive(unlocked){
  $archive.innerHTML='';
  for(let i=0;i<MESSAGES.length;i++){
    const el=document.createElement('div'); el.className='item'+(i<unlocked?'':' locked');
    const title=document.createElement('h4'); title.textContent = (i<unlocked?`Ø§Ù„ÙŠÙˆÙ… ${i+1}`:'Ù…ØºÙ„Ù‚');
    const p=document.createElement('p'); p.textContent = i<unlocked? MESSAGES[i] : 'ØªÙÙØªØ­ Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ âœ¨';
    el.appendChild(title); el.appendChild(p);
    if(i>=unlocked){ const veil=document.createElement('div'); veil.className='veil'; veil.innerHTML='ğŸ”’'; el.appendChild(veil); }
    $archive.appendChild(el);
  }
}
function updateCount(now){
  const target = nextMidnight(now);
  const ms = Math.max(0, target-now);
  const h=Math.floor(ms/3600000), m=Math.floor(ms%3600000/60000), s=Math.floor(ms%60000/1000);
  $count.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  setTimerProgress(ms);
  $nextExact.textContent = `Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ${fmtFull(target, TZ)}`;
}
function tick(){
  const now=zonedNow(TZ); const d=dayIndex(now, START);
  updateCount(now); $dateNow.textContent=fmtFull(now,TZ);
  if(d!==lastDay){ lastDay=d; renderAll(); burstHearts(); }
}

/* =================== Ù†Ø¬ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© =================== */
const scvs=document.getElementById('stars'); const sctx=scvs.getContext('2d');
let SW=innerWidth, SH=innerHeight; function srs(){ SW=innerWidth; SH=innerHeight; scvs.width=SW; scvs.height=SH; } srs(); addEventListener('resize', srs);
const STARS=[...Array(120)].map(()=>({x:Math.random()*SW,y:Math.random()*SH,r:Math.random()*1.2+0.4, s:Math.random()*0.4+0.2, a:Math.random()}));
(function starTick(){ sctx.clearRect(0,0,SW,SH); STARS.forEach(st=>{ st.a+=0.02; const twinkle=(Math.sin(st.a)+1)/2*0.7+0.3; sctx.fillStyle=`rgba(255,255,255,${twinkle})`; sctx.beginPath(); sctx.arc(st.x,st.y,st.r,0,Math.PI*2); sctx.fill(); }); requestAnimationFrame(starTick) })();

/* =================== FLAIR =================== */
function burstHearts(){
  const box=document.querySelector('.fla');
  for(let i=0;i<24;i++){
    const e=document.createElement('div'); e.className='spark';
    e.textContent=['ğŸ’–','ğŸ’—','ğŸ’˜','ğŸ’','âœ¨','ğŸŒ™'][Math.floor(Math.random()*6)];
    e.style.left=Math.random()*100+'vw'; e.style.bottom='-5vh'; e.style.animationDuration=(2.2+Math.random()*2.2)+'s';
    box.appendChild(e); setTimeout(()=>e.remove(),4200);
  }
}

/* =================== ADMIN =================== */
const dlg=$('admin'); let holdTimer=null;
$('brandHold').addEventListener('pointerdown',()=>{ holdTimer=setTimeout(()=>openAdmin(),1500) });
['pointerup','pointerleave'].forEach(ev=> $('brandHold').addEventListener(ev, ()=> clearTimeout(holdTimer)));
function openAdmin(){
  $('msgInput').value = (load(KEY_MSGS, DEFAULT_MESSAGES)||[]).join('\n');
  $('startInput').value = (new Date(START)).toISOString().slice(0,10);
  $('tzInput').value = TZ;
  dlg.setAttribute('open','');
}
$('closeAdmin').onclick = ()=> dlg.removeAttribute('open');
$('saveBtn').onclick = ()=>{
  const lines=$('msgInput').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!lines.length) return alert('Ø£Ø¶ÙŠÙÙŠ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  save(KEY_MSGS, lines); MESSAGES=lines;
  const s=$('startInput').value; const d=new Date(s+'T00:00:00'); if(!isNaN(+d)){ START=d; save(KEY_START, d.toISOString()); }
  const tz=$('tzInput').value.trim()||DEFAULT_TZ; TZ=tz; save(KEY_TZ, tz);
  dlg.removeAttribute('open'); lastDay=-1; renderAll(); burstHearts();
};
$('resetBtn').onclick = ()=>{ if(!confirm('Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ')) return; save(KEY_MSGS, DEFAULT_MESSAGES); save(KEY_START, DEFAULT_START.toISOString()); save(KEY_TZ, DEFAULT_TZ); save(KEY_SRC, ''); MESSAGES=DEFAULT_MESSAGES; START=DEFAULT_START; TZ=DEFAULT_TZ; SRC=null; dlg.removeAttribute('open'); lastDay=-1; renderAll(); };

// Import (JSON or TXT)
$('importBtn').onclick = ()=> $('fileInput').click();
$('fileInput').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text();
  try{
    const j=JSON.parse(txt);
    if(Array.isArray(j.messages)){
      save(KEY_MSGS, j.messages.map(String)); MESSAGES=j.messages.map(String);
      if(j.start_date){ const d=new Date(j.start_date+'T00:00:00'); if(!isNaN(+d)){ START=d; save(KEY_START, d.toISOString()); }}
      if(j.timezone){ TZ=j.timezone; save(KEY_TZ, TZ); }
    }else{ throw 0 }
  }catch{
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(lines.length){ save(KEY_MSGS, lines); MESSAGES=lines; }
  }
  lastDay=-1; renderAll(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…');
});

// Export JSON
$('exportBtn').onclick = ()=>{
  const data={ start_date: new Date(START).toISOString().slice(0,10), timezone: TZ, messages: MESSAGES };
  download('messages.json', JSON.stringify(data, null, 2));
};

// Reload remote
$('reloadRemote').onclick = async ()=>{
  const qs = new URLSearchParams(location.search);
  const src = qs.get('src') || SRC || prompt('Ø£Ø¯Ø®Ù„ÙŠ Ø±Ø§Ø¨Ø· messages.json');
  if(!src) return;
  try{ const {messages,start,tz} = await fetchMessagesFrom(src);
    save(KEY_MSGS,messages); save(KEY_START,start.toISOString()); save(KEY_TZ,tz); save(KEY_SRC,src);
    MESSAGES=messages; START=start; TZ=tz; SRC=src; lastDay=-1; renderAll(); alert('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· âœ…');
  }catch(e){ alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„: '+e.message); }
};

/* =================== START =================== */
(function init(){
  tryLoadExternal().then(ext=>{
    if(ext){ MESSAGES=ext.messages; START=ext.start; TZ=ext.tz; SRC=ext.src; }
    renderAll(); setInterval(tick, 1000);
  });
})();
</script>
</body>
</html>
